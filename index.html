<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Elements ---
        const startButton = document.querySelector('.start-game-btn');
        const gameOverlay = document.querySelector('.game-overlay');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas?.getContext('2d'); // Add null check
        const scoreDisplay = document.querySelector('.game-score');
        const debtCounter = document.getElementById('debt-counter');
        const priceValueElement = document.querySelector('.price-value'); // Target price display
        const priceChangeElement = document.querySelector('.price-change'); // Target change display

        // --- Helius & Token Config (INSECURE - REPLACE WITH BACKEND PROXY) ---
        const HELIUS_API_KEY = '6aa6d4e9-db65-4441-8c5b-746b40ccc3a0'; // YOUR ACTUAL HELIUS KEY - DO NOT COMMIT THIS!
        const HELIUS_RPC_URL = `https://mainnet.helius-rpc.com/?api-key=${HELIUS_API_KEY}`;
        const DEBT_MINT_ADDRESS = 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263'; // PLACEHOLDER - Bonk Mint Address
        const VS_TOKEN_MINT_ADDRESS = 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'; // USDC Mint Address
        const PRICE_API_URL = `https://price.jup.ag/v6/price?ids=${DEBT_MINT_ADDRESS}&vsToken=${VS_TOKEN_MINT_ADDRESS}`;

        // --- Game Variables ---
        let player = { x: 375, y: 440, width: 50, height: 50, color: '#ff3e3e' };
        let moneyItems = [];
        let debtItems = [];
        let keys = {};
        let score = 0;
        let gameInterval, spawnInterval, gameActive = false;

        // --- Canvas Setup ---
        if (canvas && ctx) {
             const gameContainer = document.querySelector('.game-container');
             if (gameContainer) {
                canvas.width = gameContainer.clientWidth;
                canvas.height = gameContainer.clientHeight;
                player.y = canvas.height - 60;
                player.x = canvas.width / 2 - player.width / 2;
            }
        } else {
            console.error("Canvas or Canvas Context not found!");
        }

        const emojis = { money: 'ðŸ’°', creditCard: 'ðŸ’³', studentLoan: 'ðŸ“š', audit: 'ðŸ§¾', rent: 'ðŸ“„'};
        const debtPool = [emojis.creditCard, emojis.studentLoan, emojis.audit, emojis.rent];

        // --- Price Fetching Function ---
        async function fetchAndUpdatePrice() {
            if (!priceValueElement) return; // Don't fetch if element doesn't exist

            console.log("Fetching price from:", PRICE_API_URL); // Log the URL being fetched

            try {
                // IMPORTANT: In a real app, this fetch call MUST go through your secure backend proxy
                const response = await fetch(PRICE_API_URL);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Price API Response:", data); // Log the response data

                if (data.data && data.data[DEBT_MINT_ADDRESS]) {
                    const priceData = data.data[DEBT_MINT_ADDRESS];
                    const currentPrice = priceData.price;

                    // Format the price (adjust decimals as needed for the actual token)
                    const formattedPrice = currentPrice.toFixed(9); // Show 9 decimal places

                    priceValueElement.textContent = '$' + formattedPrice;

                    // Keep the satirical price change for now
                    // To implement real % change, you'd need historical data
                    const change = -(Math.random() * 4.99 + 95).toFixed(2);
                    if (priceChangeElement) {
                        priceChangeElement.textContent = change + '%';
                        if (!priceChangeElement.classList.contains('negative')) {
                           priceChangeElement.classList.add('negative');
                        }
                    }

                } else {
                    console.error("Price data not found for mint address in API response:", DEBT_MINT_ADDRESS);
                    priceValueElement.textContent = '$-.--'; // Indicate error
                }

            } catch (error) {
                console.error("Failed to fetch token price:", error);
                // Display an error state or leave the last known price
                 if (priceValueElement.textContent.startsWith('$')) {
                    // keep the old price if fetch fails
                 } else {
                    priceValueElement.textContent = '$?.??????'; // Fallback display on error
                 }
            }
        }

        // --- Event Listeners ---
        if (startButton) {
            startButton.addEventListener('click', function() {
                if (!gameActive && canvas && ctx) { // Ensure canvas is ready
                   gameOverlay.style.display = 'none';
                   startGame();
                }
            });
        }

        document.addEventListener('keydown', e => {
            keys[e.key] = true;
            if (gameActive && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                e.preventDefault();
            }
        });
        document.addEventListener('keyup', e => { keys[e.key] = false });


        // --- Game Functions ---
        function startGame() {
            // (Game logic remains the same as the previous version)
            gameActive = true;
            moneyItems = [];
            debtItems = [];
            score = 0;
            updateScore();
            player.x = canvas.width / 2 - player.width / 2;

            clearInterval(gameInterval);
            clearInterval(spawnInterval);

            gameInterval = setInterval(updateGame, 1000 / 60);
            spawnInterval = setInterval(spawnObjects, 900);
        }

        function endGame() {
            // (Game logic remains the same)
             gameActive = false;
            clearInterval(gameInterval);
            clearInterval(spawnInterval);
            if (gameOverlay) {
                gameOverlay.style.display = 'flex';
                const gameTitle = gameOverlay.querySelector('.game-title');
                 if (gameTitle) gameTitle.textContent = `GAME OVER! Score: ${score}`;
                 // Reset title for next game potentially
                 setTimeout(() => {
                    if (gameTitle) gameTitle.textContent = 'DEBT DODGER';
                 }, 3000);
            }
        }

         function updateScore() {
            if (scoreDisplay) scoreDisplay.textContent = `SCORE: ${score}`;
        }

        function spawnObjects() {
            if (!gameActive || !canvas) return;
             // (Spawn logic remains the same)
            if (Math.random() < 0.5) { moneyItems.push({ x: Math.random()*(canvas.width-30), y: -30, emoji: emojis.money }); }
            if (Math.random() < 0.6) { debtItems.push({ x: Math.random()*(canvas.width-30), y: -30, emoji: debtPool[Math.floor(Math.random()*debtPool.length)] }); }
        }

        function updateGame() {
            if (!gameActive || !canvas || !ctx) return;
            // (Player movement and drawing logic remains the same)
             if (keys['ArrowLeft'] || keys['a']) player.x -= 6;
             if (keys['ArrowRight'] || keys['d']) player.x += 6;
             player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

             ctx.clearRect(0, 0, canvas.width, canvas.height);
             ctx.fillStyle = player.color;
             ctx.fillRect(player.x, player.y, player.width, player.height);
             ctx.font = "24px Arial"; ctx.textAlign = "center";
             ctx.fillText("ðŸ˜°", player.x + player.width / 2, player.y + 35);

            const itemSize = 30; ctx.font = `${itemSize}px Arial`;

            // Money items
             for (let i = moneyItems.length - 1; i >= 0; i--) {
                let item = moneyItems[i]; item.y += 4;
                ctx.fillText(item.emoji, item.x + itemSize/2, item.y + itemSize);
                if (isColliding(player, { x: item.x, y: item.y, width: itemSize, height: itemSize })) {
                    score += 10; updateScore(); moneyItems.splice(i, 1);
                } else if (item.y > canvas.height) { moneyItems.splice(i, 1); }
            }
            // Debt items
            for (let i = debtItems.length - 1; i >= 0; i--) {
                let item = debtItems[i]; item.y += 5;
                 ctx.fillText(item.emoji, item.x + itemSize/2, item.y + itemSize);
                if (isColliding(player, { x: item.x, y: item.y, width: itemSize, height: itemSize })) {
                    endGame(); return; // Exit early on game over
                } else if (item.y > canvas.height) { debtItems.splice(i, 1); }
            }
        }

        function isColliding(rect1, rect2) {
            // (Collision logic remains the same)
             return ( rect1.x < rect2.x + rect2.width && rect1.x + rect1.width > rect2.x && rect1.y < rect2.y + rect2.height && rect1.y + rect1.height > rect2.y );
        }


        // --- Other Dynamic Elements ---
        function updateDebtCounter() {
            // (Debt counter logic remains the same)
            if (!debtCounter) return;
             const currentDebt = parseInt(debtCounter.textContent.replace(/\D/g,'')) || 300000000000000;
             const increment = Math.floor(Math.random() * 1000000000) + 50000000;
             const newDebt = currentDebt + increment;
             debtCounter.textContent = '$' + newDebt.toLocaleString('en-US');
        }
        setInterval(updateDebtCounter, 1500);


        // --- Financial Advice Popup ---
        const adviceMessages = [ /* ... advice messages ... */
            "Financial Advice: Buy high, sell low!", "Have you considered a third mortgage?", "Pro Tip: Credit cards are just free money!", "Diamond hands mean never seeing profits!", "If you can't afford it, finance it!", "BREAKING: Your portfolio is underperforming inflation!", "Fun Fact: Ramen has all essential nutrients!", "Your landlord just bought more $DEBT than you!", "WARNING: Your credit score just dropped 100 points!", "ALERT: Your bank account is filing for divorce!", "Remember: It's only a loss if you sell!", "This is definitely financial advice. Trust me.", "FOMO is your best investment indicator."
        ];
        function showRandomAdvice() {
             // (Advice popup logic remains the same)
             const msg=adviceMessages[Math.floor(Math.random()*adviceMessages.length)]; const popup=document.createElement('div'); popup.className='advice-popup'; popup.textContent=msg; document.body.appendChild(popup); setTimeout(()=>{ popup.classList.add('fade-out'); popup.addEventListener('animationend',()=>{popup.remove();}); },4000);
        }
        function scheduleAdvice() {
            // (Advice scheduling logic remains the same)
            const delay = Math.random()*10000+15000; setTimeout(()=>{ showRandomAdvice(); scheduleAdvice(); }, delay);
        }


        // --- Initializations ---
        fetchAndUpdatePrice(); // Fetch price immediately on load
        setInterval(fetchAndUpdatePrice, 60000); // Fetch price every 60 seconds
        scheduleAdvice(); // Start advice popups

    });
</script>
